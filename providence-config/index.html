<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.1 at 2016-10-10 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20161010" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Providence &#x2013; Providence Utils : Config</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/morimekta/providence">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Providence Utils : Config</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2016-10-10
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.2.2
                      </li>
                      
              
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Project Documentation</li>
                                                                                                                                                
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-down"></span>
        Project Information</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="dependencies.html" title="Dependencies">
          <span class="none"></span>
        Dependencies</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>About</a>
          </li>
                    
      <li>
  
                          <a href="license.html" title="Licenses">
          <span class="none"></span>
        Licenses</a>
            </li>
                    
      <li>
  
                          <a href="team-list.html" title="Team">
          <span class="none"></span>
        Team</a>
            </li>
              </ul>
        </li>
                                                                                    
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
                              <li class="nav-header">Introduction</li>
                              
      <li>
  
                          <a href="../index.html" title="Providence">
          <span class="none"></span>
        Providence</a>
            </li>
                
      <li>
  
                          <a href="../providence-tools.html" title="Providence Tools">
          <span class="none"></span>
        Providence Tools</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/morimekta/providence/releases" class="externalLink" title="Downloads & Releases">
          <span class="none"></span>
        Downloads & Releases</a>
            </li>
                              <li class="nav-header">Modules</li>
                              
      <li>
  
                          <a href="../providence-core/index.html" title="Core">
          <span class="none"></span>
        Core</a>
            </li>
                
      <li>
  
                          <a href="../providence-core-jackson/index.html" title="Core : Jackson">
          <span class="none"></span>
        Core : Jackson</a>
            </li>
                
      <li>
  
                          <a href="../providence-core-client/index.html" title="Core : Client">
          <span class="none"></span>
        Core : Client</a>
            </li>
                
      <li>
  
                          <a href="../providence-reflect/index.html" title="Utils : Reflect">
          <span class="none"></span>
        Utils : Reflect</a>
            </li>
                
      <li>
  
                          <a href="../providence-thrift/index.html" title="Utils : Thrift Bridge">
          <span class="none"></span>
        Utils : Thrift Bridge</a>
            </li>
                
      <li>
  
                          <a href="../providence-testing/index.html" title="Utils : Testing">
          <span class="none"></span>
        Utils : Testing</a>
            </li>
                
      <li>
  
                          <a href="../providence-config/index.html" title="Utils : Config">
          <span class="none"></span>
        Utils : Config</a>
            </li>
                
      <li>
  
                          <a href="../providence-generator/index.html" title="Tools : Generator">
          <span class="none"></span>
        Tools : Generator</a>
            </li>
                
      <li>
  
                          <a href="../providence-generator-java/index.html" title="Tools : Generator - Java">
          <span class="none"></span>
        Tools : Generator - Java</a>
            </li>
                
      <li>
  
                          <a href="../providence-generator-java/tiny-java.html" title="Tools : Generator - Tiny Java">
          <span class="none"></span>
        Tools : Generator - Tiny Java</a>
            </li>
                
      <li>
  
                          <a href="../providence-generator-json/index.html" title="Tools : Generator - JSON">
          <span class="none"></span>
        Tools : Generator - JSON</a>
            </li>
                
      <li>
  
                          <a href="../providence-maven-plugin/index.html" title="Tools : Maven Plugin">
          <span class="none"></span>
        Tools : Maven Plugin</a>
            </li>
                              <li class="nav-header">Docs</li>
                              
      <li>
  
                          <a href="../release.html" title="Release Process">
          <span class="none"></span>
        Release Process</a>
            </li>
                
      <li>
  
                          <a href="../integration-testing.html" title="Integration Testing">
          <span class="none"></span>
        Integration Testing</a>
            </li>
                
      <li>
  
                          <a href="../serializer-binary.html" title="Serializer : Binary">
          <span class="none"></span>
        Serializer : Binary</a>
            </li>
                
      <li>
  
                          <a href="../serializer-fast-binary.html" title="Serializer : Fast Binary">
          <span class="none"></span>
        Serializer : Fast Binary</a>
            </li>
                
      <li>
  
                          <a href="../serializer-json.html" title="Serializer : JSON">
          <span class="none"></span>
        Serializer : JSON</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Providence Utils : Config</h1>
<p>Providence config is a special config format for generating providence message objects. The reason for having a specific config format in this way is to solve the &#x201c;structured + modular&#x201d; problem. If you&#x2019;re not familiar here is a short wrap-up.</p>
<div class="section">
<div class="section">
<div class="section">
<h4><a name="The_Problem_of_Structured_Config"></a>The Problem of Structured Config</h4>
<p>When choosing a config language (or config markup language), you need to consider what you use the config for. But what we would really like have four main properties:</p>

<ol style="list-style-type: decimal">
  
<li><tt>schema-defined</tt>: The config has a strict schema that can be used  to validate it, e.g. in testing pipelines. But the schema needs to  be at least as modular as the config itself, and possible to  define in a remote / distributed fashion.</li>
  
<li><tt>structured</tt>: The config must have structure that can be utilized to  group and pass a part of the whole. E.g. if you need 3 database  connections, but each should just produce a DBI instance, that is  an example of a good use for structured config: Each has a part of  the config that is internally identical configuring that DB connection.</li>
  
<li><tt>type-safe</tt>: The code that use the config should be type-safe, so  at compile-time, I know if the value I look at is an integer or a  string.</li>
  
<li><tt>modular</tt>: The config must support to be be split into multiple files,  that can be combined or merged into a single &#x201c;config&#x201d; without messing up  the &#x201c;type&#x201d; something in the config is.</li>
</ol>
<p>In addition we want to avoid a couple of dogmas that makes it difficult to follow what goes on with the config: <tt>arithmetics</tt> and <tt>scripting</tt>. If you need logic to generate your config, you should do that in a proper programming or scripting language, and not bake it into the config itself. But if you really need scripting, you should use pure <tt>java</tt>, <tt>groovy</tt> or similar.</p>

<ul>
  
<li>PS: This is one of the pitfalls of the <tt>bcl</tt> / <tt>gcl</tt> configuration language  of Google (see  <a class="externalLink" href="http://alexandria.tue.nl/extra1/afstversl/wsk-i/bokharouss2008.pdf">here</a>  for example), which gives full arithmetic and scripting control to the  config writer, which in turns had a tendency of making the config files  almost unreadable and a pretty unpopular task of managing.</li>
</ul>
<p>If you want to have a schema-defined, structured, type-safe config, you can choose <tt>thrift</tt>, <tt>protobuf</tt> or <tt>providence</tt> serialized formats. All of these fills <tt>1.</tt>, <tt>2.</tt> and <tt>3.</tt> natively. And they all support a &#x201c;simple&#x201d; modularization by merging or &#x201c;overloading&#x201d; messages. Ignoring the &#x201c;readable and writable config format&#x201d; part, there is the problem of modularizing a schema-defined system like that: <b>Where is the definition for what module, and how do you merge them?</b> And here lies the whole reason for <tt>providence-config</tt>.</p>
<p>If you want to have a config that is type-safe both in the written config file input to the parser, to the code that uses that config, using a model builder like providence should be a no-brainer. But when the config is this strictly defined, making it truly modular becomes a non-trivial problem: We simply don&#x2019;t want to have a single central definition of &#x201c;the config&#x201d;, but be able to build up the config for each application by modules used by the various parts that it contains: it&#x2019;s libraries and local code.</p>
<p>This is the <tt>providence</tt> project, so guess what, it is the base definition. And since providence support modular schema definitions, it&#x2019;s config system needs to support modularity of the config in the same way.</p></div></div>
<div class="section">
<h3><a name="Config_file_Syntax"></a>Config file Syntax</h3>
<p>In general the config files use the suffix <tt>.cfg</tt>, but <tt>.pvd</tt> should be fine too. In practice it should be irrelevant. But here is an overview over the providence config file syntax:</p>

<ul>
  
<li>Comments follow the &#x2018;shell comment&#x2019; syntax. Starts with a  <tt>#</tt>, and ends in a newline. In that line, everything is allowed.  The comment can start anywhere except inside a string literal.</li>
  
<li>The config has three parts, which <i>must</i> come in this order,  where the two first are optional.
  
<ul>
    
<li>The <tt>params</tt>: A set of &#x2018;simple&#x2019; values that can be referenced  in the config.</li>
    
<li>The <tt>includes</tt>: Other config files included with an alias, so  they too can be referenced from the config.</li>
    
<li>The <tt>message</tt>: The &#x2018;content&#x2019; of the config itself.</li>
  </ul></li>
  
<li>The <tt>params</tt> follow a simple &#x2018;map&#x2019; syntax where the key must be  a simple identifier <tt>/[_a-z][_a-zA-Z0-9]/</tt>, and a simple value (number,  string, enum, boolean). The params value may be a declared (known)  enum, with the double qualified identifier syntax <tt>package.Name.VALUE</tt>.</li>
  
<li>The <tt>include</tt> section is a set of similarly included config files.  Each file is given an <tt>alias</tt>. E.g. <tt>include &quot;other.cfg&quot; as o</tt> will  make the &#x2018;o&#x2019; reference point to the content of the &#x201c;other.cfg&#x201d; config.</li>
  
<li>The <tt>message</tt> is a providence message, and is declared with the  qualified typename (package.Name), and the content, following this  syntax: <tt>TYPENAME (':' EXTEND)? '{' FIELD_VALUE* '}'</tt>, where the  <tt>FIELD_VALUE</tt> part follows the &#x2018;pretty&#x2019; serializer syntax (using the &#x2018;=&#x2019;  field-value separator), with added support for references for values.  The references can only reference params or content from imported  config files. Messages has four specific modes of value specification,  specified with what comes after the field name.
  
<ul>
    
<li>&#x2018;=&#x2019; means &#x201c;overwrite with&#x201d;, otherwise the parent (extended) message  values will be used as the base message.</li>
    
<li>After the &#x2018;=&#x2019; there can be an optional reference to use as the base  message instead of the default one.</li>
    
<li>The extension content is delimited by the &#x2018;{&#x2019; and &#x2018;}&#x2019; chars.</li>
    
<li>One of the reference or extend content <i>must</i> be present.</li>
  </ul></li>
</ul>
<div class="section">
<h4><a name="A_note_on_field_values"></a>A note on field values</h4>
<p>Note that both messages and maps can be extended, but lists and sets can not (yet at least). This is because managing lists and sets is a bit more complicated in the form of how to make modifications explicit, truly visible and not confusing. E.g. if you need to remove a single element from a list e.g. with <tt>slice()</tt>, there is no way of showing which element is actually removed without referencing it with <tt>.remove(value)</tt>, and with syntax like that we get into the whole world of &#x201c;scripting&#x201d;.</p>
<p>Example of config syntax:</p>

<div class="source">
<div class="source"><pre class="prettyprint">params {
  name1 = &quot;value&quot;
  number = 12345.6789
}

include &quot;filepath&quot; as alias

package.Struct : alias {
    key = params.name1
    key2 = 321

    # Extending the existing message
    substruct {
       sub = &quot;value&quot;
    }
    # Overwriting with a new message
    substruct = {
       sub = &quot;value&quot;
    }
    # Replacing with a reference
    substruct = alias.sub2
    # Reaplcing with a reference that is extended.
    substruct = alias.sub2 {
       sub = &quot;value&quot;
    }
}
</pre></div></div>
<p>And using the command, output matching the pretty-print output from providence.</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ pvdcfg -I . print myfile.cfg
{
  key = &quot;value&quot;
  key2 = 321
  substruct = {
    sub = &quot;value&quot;
  }
}
</pre></div></div></div></div>
<div class="section">
<h3><a name="Java_Interface"></a>Java Interface</h3>
<p>The interface for using this config in code should be fairly easy to use. In order to read a simple config structure, you can use a code snippet like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">class Loader {
    public Named load() {
        Map&lt;String,String&gt; params = new HashMap&lt;&gt;();
        // E.g. load params from flags here.
        
        TypeRegistry reg = new TypeRegistry();
        // sadly all types needs to be registered, so a utility to register all
        // subtypes are needed. 
        reg.putRecursiveType(Named.kDescriptor);
        reg.putRecursiveType(From.kDescriptor);
    
        ProvidenceConfig cfg = new ProvidenceConfig(reg, params);
        return cfg.load(&quot;myfile.cfg&quot;);
    }
}
</pre></div></div></div>
<div class="section">
<h3><a name="Sources_Root"></a>Sources Root</h3>
<p>Files referenced in the include statements can follow one of two patterns.&quot;</p>

<ul>
  
<li>Relative to the PWD directory of the including file.</li>
  
<li>Relative to (not including parent directories) of one of the &#x201c;config roots&#x201d;.</li>
</ul>
<p>Each config root is simply a directory that contains configs, including subdirectories.</p>
<p>With this path inclusion with ways of overriding, it should be possible to change what files are included based on a set of config source root directories, and swapping out directories based on the current &#x201c;mode&#x201d; of operation.</p>
<p>Note that it is currently <b>not</b> possible to swap out individual config files without using symlinks or similar, and it is not possible to load config directly from resources. In those cases, you should use the &#x201c;compiled&#x201d; config output instead of the raw config files.</p></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                          <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-3087264-4', 'auto');
                ga('send', 'pageview');
            </script>
                </div>

        
                </div>
    </footer>
        </body>
</html>
