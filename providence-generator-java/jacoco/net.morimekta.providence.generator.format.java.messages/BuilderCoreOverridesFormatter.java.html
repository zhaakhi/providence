<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BuilderCoreOverridesFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Generator : Java</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.generator.format.java.messages</a> &gt; <span class="el_source">BuilderCoreOverridesFormatter.java</span></div><h1>BuilderCoreOverridesFormatter.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Providence Authors
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package net.morimekta.providence.generator.format.java.messages;

import net.morimekta.providence.PMessageBuilder;
import net.morimekta.providence.PType;
import net.morimekta.providence.descriptor.PContainer;
import net.morimekta.providence.descriptor.PDescriptor;
import net.morimekta.providence.generator.GeneratorException;
import net.morimekta.providence.generator.format.java.shared.MessageMemberFormatter;
import net.morimekta.providence.generator.format.java.utils.JAnnotation;
import net.morimekta.providence.generator.format.java.utils.JField;
import net.morimekta.providence.generator.format.java.utils.JHelper;
import net.morimekta.providence.generator.format.java.utils.JMessage;
import net.morimekta.util.Strings;
import net.morimekta.util.io.IndentedPrintWriter;

import java.util.ArrayList;

import static net.morimekta.providence.generator.format.java.messages.CoreOverridesFormatter.UNION_FIELD;

/**
 * @author Stein Eldar Johnsen
 * @since 08.01.16.
 */
public class BuilderCoreOverridesFormatter implements MessageMemberFormatter {
    private final IndentedPrintWriter writer;
    private final JHelper             helper;

<span class="fc" id="L48">    public BuilderCoreOverridesFormatter(IndentedPrintWriter writer, JHelper helper) {</span>
<span class="fc" id="L49">        this.writer = writer;</span>
<span class="fc" id="L50">        this.helper = helper;</span>
<span class="fc" id="L51">    }</span>

    @Override
    public void appendConstructors(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L55">        appendMerge(message);</span>
<span class="fc" id="L56">    }</span>

    @Override
    public void appendMethods(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L60">        appendOverrideMutator(message);</span>
<span class="fc" id="L61">        appendOverrideSetter(message);</span>
<span class="fc" id="L62">        appendOverrideIsSet(message);</span>
<span class="fc" id="L63">        appendOverrideIsModified(message);</span>
<span class="fc" id="L64">        appendOverrideAdder(message);</span>
<span class="fc" id="L65">        appendOverrideResetter(message);</span>
<span class="fc" id="L66">        appendOverrideIsValid(message);</span>
<span class="fc" id="L67">        appendOverrideValidate(message);</span>
<span class="fc" id="L68">        appendOverrideDescriptor(message);</span>
<span class="fc" id="L69">    }</span>

    private void appendMerge(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L72">        writer.appendln(JAnnotation.NON_NULL)</span>
<span class="fc" id="L73">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L74">              .formatln(&quot;public _Builder merge(%s from) {&quot;, message.instanceType())</span>
<span class="fc" id="L75">              .begin();</span>

<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L78">            writer.appendln(&quot;if (!from.unionFieldIsSet()) {&quot;)</span>
<span class="fc" id="L79">                  .appendln(&quot;    return this;&quot;)</span>
<span class="fc" id="L80">                  .appendln(&quot;}&quot;)</span>
<span class="fc" id="L81">                  .newline()</span>
<span class="fc" id="L82">                  .appendln(&quot;switch (from.unionField()) {&quot;)</span>
<span class="fc" id="L83">                  .begin();</span>

<span class="fc bfc" id="L85" title="All 2 branches covered.">            for (JField field : message.declaredOrderFields()) {</span>
<span class="fc" id="L86">                writer.formatln(&quot;case %s: {&quot;, field.fieldEnum())</span>
<span class="fc" id="L87">                      .begin();</span>

<span class="pc bfc" id="L89" title="All 5 branches covered.">                switch (field.type()) {</span>
                    case VOID:
                        // Void fields have no value.
<span class="fc" id="L92">                        writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L93">                        break;</span>
                    case MESSAGE:
<span class="fc" id="L95">                        writer.formatln(&quot;if (%s == _Field.%s &amp;&amp; %s != null) {&quot;,</span>
                                        UNION_FIELD,
<span class="fc" id="L97">                                        field.fieldEnum(),</span>
<span class="fc" id="L98">                                        field.member())</span>
<span class="fc" id="L99">                              .formatln(&quot;    %s = %s.mutate().merge(from.%s()).build();&quot;,</span>
<span class="fc" id="L100">                                        field.member(),</span>
<span class="fc" id="L101">                                        field.member(),</span>
<span class="fc" id="L102">                                        field.getter())</span>
<span class="fc" id="L103">                              .appendln(&quot;} else {&quot;)</span>
<span class="fc" id="L104">                              .formatln(&quot;    %s(from.%s());&quot;, field.setter(), field.getter())</span>
<span class="fc" id="L105">                              .appendln('}');</span>
<span class="fc" id="L106">                        break;</span>
                    case SET:
<span class="fc" id="L108">                        writer.formatln(&quot;if (%s == _Field.%s) {&quot;, UNION_FIELD, field.fieldEnum())</span>
<span class="fc" id="L109">                              .formatln(&quot;    %s().addAll(from.%s());&quot;, field.mutable(), field.getter())</span>
<span class="fc" id="L110">                              .appendln(&quot;} else {&quot;)</span>
<span class="fc" id="L111">                              .formatln(&quot;    %s(from.%s());&quot;, field.setter(), field.getter())</span>
<span class="fc" id="L112">                              .appendln('}');</span>
<span class="fc" id="L113">                        break;</span>
                    case MAP:
<span class="fc" id="L115">                        writer.formatln(&quot;if (%s == _Field.%s) {&quot;, UNION_FIELD, field.fieldEnum())</span>
<span class="fc" id="L116">                              .formatln(&quot;    %s().putAll(from.%s());&quot;, field.mutable(), field.getter())</span>
<span class="fc" id="L117">                              .appendln(&quot;} else {&quot;)</span>
<span class="fc" id="L118">                              .formatln(&quot;    %s(from.%s());&quot;, field.setter(), field.getter())</span>
<span class="fc" id="L119">                              .appendln('}');</span>
<span class="fc" id="L120">                        break;</span>
                    default:
<span class="fc" id="L122">                        writer.formatln(&quot;%s(from.%s());&quot;, field.setter(), field.getter());</span>
                        break;
                }

<span class="fc" id="L126">                writer.appendln(&quot;break;&quot;)</span>
<span class="fc" id="L127">                      .end()</span>
<span class="fc" id="L128">                      .appendln('}');</span>
<span class="fc" id="L129">            }</span>

<span class="fc" id="L131">            writer.end()</span>
<span class="fc" id="L132">                  .appendln('}');</span>
        } else {
<span class="fc" id="L134">            boolean first = true;</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">            for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L137">                    first = false;</span>
                } else {
<span class="fc" id="L139">                    writer.newline();</span>
                }

<span class="fc bfc" id="L142" title="All 2 branches covered.">                if (!field.alwaysPresent()) {</span>
<span class="fc" id="L143">                    writer.formatln(&quot;if (from.%s()) {&quot;, field.presence())</span>
<span class="fc" id="L144">                          .begin();</span>
                }

<span class="fc" id="L147">                writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L148">                writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>

<span class="fc bfc" id="L150" title="All 4 branches covered.">                switch (field.type()) {</span>
                    case MESSAGE:
                        // Message fields are merged.
<span class="fc" id="L153">                        writer.formatln(&quot;if (%s_builder != null) {&quot;, field.member())</span>
<span class="fc" id="L154">                              .formatln(&quot;    %s_builder.merge(from.%s());&quot;, field.member(), field.getter())</span>
<span class="fc" id="L155">                              .formatln(&quot;} else if (%s != null) {&quot;, field.member())</span>
<span class="fc" id="L156">                              .formatln(&quot;    %s_builder = %s.mutate().merge(from.%s());&quot;,</span>
<span class="fc" id="L157">                                        field.member(),</span>
<span class="fc" id="L158">                                        field.member(),</span>
<span class="fc" id="L159">                                        field.getter())</span>
<span class="fc" id="L160">                              .formatln(&quot;    %s = null;&quot;, field.member())</span>
<span class="fc" id="L161">                              .appendln(&quot;} else {&quot;)</span>
<span class="fc" id="L162">                              .formatln(&quot;    %s = from.%s();&quot;, field.member(), field.getter())</span>
<span class="fc" id="L163">                              .appendln('}');</span>
<span class="fc" id="L164">                        break;</span>
                    case SET:
<span class="fc" id="L166">                        writer.formatln(&quot;%s().addAll(from.%s());&quot;, field.mutable(), field.getter());</span>
<span class="fc" id="L167">                        break;</span>
                    case MAP:
<span class="fc" id="L169">                        writer.formatln(&quot;%s().putAll(from.%s());&quot;, field.mutable(), field.getter());</span>
<span class="fc" id="L170">                        break;</span>
                    default:
<span class="fc" id="L172">                        writer.formatln(&quot;%s = from.%s();&quot;, field.member(), field.getter());</span>
                        break;
                }

<span class="fc bfc" id="L176" title="All 2 branches covered.">                if (!field.alwaysPresent()) {</span>
<span class="fc" id="L177">                    writer.end()</span>
<span class="fc" id="L178">                          .appendln('}');</span>
                }
<span class="fc" id="L180">            }</span>
        }

<span class="fc" id="L183">        writer.appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L184">              .end()</span>
<span class="fc" id="L185">              .appendln('}')</span>
<span class="fc" id="L186">              .newline();</span>
<span class="fc" id="L187">    }</span>

    private void appendOverrideMutator(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L190">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L191">              .appendln(&quot;@SuppressWarnings(\&quot;unchecked\&quot;)&quot;)</span>
<span class="fc" id="L192">              .formatln(&quot;public %s mutator(int key) {&quot;, PMessageBuilder.class.getName())</span>
<span class="fc" id="L193">              .begin()</span>
<span class="fc" id="L194">              .appendln(&quot;switch (key) {&quot;)</span>
<span class="fc" id="L195">              .begin();</span>
<span class="fc" id="L196">        message.numericalOrderFields()</span>
<span class="fc" id="L197">               .stream()</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">               .filter(field -&gt; field.type() == PType.MESSAGE)</span>
<span class="fc" id="L199">               .forEachOrdered(field -&gt; writer.formatln(&quot;case %d: return %s();&quot;,</span>
<span class="fc" id="L200">                                                        field.id(),</span>
<span class="fc" id="L201">                                                        Strings.camelCase(&quot;mutable&quot;, field.name())));</span>
<span class="fc" id="L202">        writer.appendln(&quot;default: throw new IllegalArgumentException(\&quot;Not a message field ID: \&quot; + key);&quot;)</span>
<span class="fc" id="L203">              .end()</span>
<span class="fc" id="L204">              .appendln('}')</span>
<span class="fc" id="L205">              .end()</span>
<span class="fc" id="L206">              .appendln('}')</span>
<span class="fc" id="L207">              .newline();</span>
<span class="fc" id="L208">    }</span>

    private void appendOverrideSetter(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L211">        writer.appendln(JAnnotation.NON_NULL)</span>
<span class="fc" id="L212">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L213">              .appendln(&quot;@SuppressWarnings(\&quot;unchecked\&quot;)&quot;)</span>
<span class="fc" id="L214">              .appendln(&quot;public _Builder set(int key, Object value) {&quot;)</span>
<span class="fc" id="L215">              .begin()</span>
<span class="fc" id="L216">              .appendln(&quot;if (value == null) return clear(key);&quot;)</span>
<span class="fc" id="L217">              .appendln(&quot;switch (key) {&quot;)</span>
<span class="fc" id="L218">              .begin();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">        for (JField field : message.numericalOrderFields()) {</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">            if (field.isVoid()) {</span>
                // Void fields have no value.
<span class="fc" id="L222">                writer.formatln(&quot;case %d: %s(); break;&quot;, field.id(), field.setter(), field.valueType());</span>
            } else {
<span class="fc" id="L224">                writer.formatln(&quot;case %d: %s((%s) value); break;&quot;, field.id(), field.setter(), field.valueType());</span>
            }
<span class="fc" id="L226">        }</span>
<span class="fc" id="L227">        writer.appendln(&quot;default: break;&quot;)</span>
<span class="fc" id="L228">              .end()</span>
<span class="fc" id="L229">              .appendln('}')</span>
<span class="fc" id="L230">              .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L231">              .end()</span>
<span class="fc" id="L232">              .appendln('}')</span>
<span class="fc" id="L233">              .newline();</span>
<span class="fc" id="L234">    }</span>

    private void appendOverrideIsSet(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L237">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L238">              .appendln(&quot;public boolean isSet(int key) {&quot;)</span>
<span class="fc" id="L239">              .begin()</span>
<span class="fc" id="L240">              .appendln(&quot;switch (key) {&quot;)</span>
<span class="fc" id="L241">              .begin();</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">            for (JField field : message.numericalOrderFields()) {</span>
<span class="fc" id="L244">                writer.formatln(&quot;case %d: return %s == _Field.%s;&quot;, field.id(), UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L245">            }</span>
        } else {
<span class="fc bfc" id="L247" title="All 2 branches covered.">            for (JField field : message.numericalOrderFields()) {</span>
<span class="fc" id="L248">                writer.formatln(&quot;case %d: return optionals.get(%d);&quot;, field.id(), field.index());</span>
<span class="fc" id="L249">            }</span>
        }
<span class="fc" id="L251">        writer.appendln(&quot;default: break;&quot;)</span>
<span class="fc" id="L252">              .end()</span>
<span class="fc" id="L253">              .appendln('}')</span>
<span class="fc" id="L254">              .appendln(&quot;return false;&quot;)</span>
<span class="fc" id="L255">              .end()</span>
<span class="fc" id="L256">              .appendln('}')</span>
<span class="fc" id="L257">              .newline();</span>
<span class="fc" id="L258">    }</span>

    private void appendOverrideIsModified(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L261">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L262">              .appendln(&quot;public boolean isModified(int key) {&quot;)</span>
<span class="fc" id="L263">              .begin();</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L265">            writer.appendln(&quot;switch (key) {&quot;)</span>
<span class="fc" id="L266">                  .begin();</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">            for (JField field : message.numericalOrderFields()) {</span>
<span class="fc" id="L268">                writer.formatln(&quot;case %d: return modified.get(%d);&quot;, field.id(), field.index());</span>
<span class="fc" id="L269">            }</span>
<span class="fc" id="L270">            writer.appendln(&quot;default: break;&quot;)</span>
<span class="fc" id="L271">                  .end()</span>
<span class="fc" id="L272">                  .appendln('}')</span>
<span class="fc" id="L273">                  .appendln(&quot;return false;&quot;);</span>
        } else {
<span class="fc" id="L275">            writer.appendln(&quot;return modified;&quot;);</span>
<span class="fc" id="L276">        } writer.end()</span>
<span class="fc" id="L277">                .appendln('}')</span>
<span class="fc" id="L278">                .newline();</span>
<span class="fc" id="L279">    }</span>

    private void appendOverrideAdder(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L282">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L283">              .appendln(&quot;public _Builder addTo(int key, Object value) {&quot;)</span>
<span class="fc" id="L284">              .begin()</span>
<span class="fc" id="L285">              .appendln(&quot;switch (key) {&quot;)</span>
<span class="fc" id="L286">              .begin();</span>
<span class="fc" id="L287">        message.numericalOrderFields()</span>
<span class="fc" id="L288">               .stream()</span>
<span class="fc bfc" id="L289" title="All 4 branches covered.">               .filter(field -&gt; field.type() == PType.LIST || field.type() == PType.SET)</span>
<span class="fc" id="L290">               .forEachOrdered(field -&gt; {</span>
<span class="fc" id="L291">                   PContainer&lt;?&gt; ct = (PContainer&lt;?&gt;) field.field()</span>
<span class="fc" id="L292">                                                           .getDescriptor();</span>
<span class="fc" id="L293">                   PDescriptor itype = ct.itemDescriptor();</span>
<span class="fc" id="L294">                   writer.formatln(&quot;case %d: %s((%s) value); break;&quot;,</span>
<span class="fc" id="L295">                                   field.id(),</span>
<span class="fc" id="L296">                                   field.adder(),</span>
<span class="fc" id="L297">                                   helper.getValueType(itype));</span>
<span class="fc" id="L298">               });</span>
<span class="fc" id="L299">        writer.appendln(&quot;default: break;&quot;)</span>
<span class="fc" id="L300">              .end()</span>
<span class="fc" id="L301">              .appendln('}')</span>
<span class="fc" id="L302">              .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L303">              .end()</span>
<span class="fc" id="L304">              .appendln('}')</span>
<span class="fc" id="L305">              .newline();</span>
<span class="fc" id="L306">    }</span>

    private void appendOverrideResetter(JMessage&lt;?&gt; message) {
<span class="fc" id="L309">        writer.appendln(JAnnotation.NON_NULL)</span>
<span class="fc" id="L310">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L311">              .appendln(&quot;public _Builder clear(int key) {&quot;)</span>
<span class="fc" id="L312">              .begin()</span>
<span class="fc" id="L313">              .appendln(&quot;switch (key) {&quot;)</span>
<span class="fc" id="L314">              .begin();</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">        for (JField field : message.numericalOrderFields()) {</span>
<span class="fc" id="L316">            writer.formatln(&quot;case %d: %s(); break;&quot;, field.id(), field.resetter());</span>
<span class="fc" id="L317">        }</span>
<span class="fc" id="L318">        writer.appendln(&quot;default: break;&quot;)</span>
<span class="fc" id="L319">              .end()</span>
<span class="fc" id="L320">              .appendln('}')</span>
<span class="fc" id="L321">              .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L322">              .end()</span>
<span class="fc" id="L323">              .appendln('}')</span>
<span class="fc" id="L324">              .newline();</span>
<span class="fc" id="L325">    }</span>

    private void appendOverrideIsValid(JMessage&lt;?&gt; message) {
<span class="fc" id="L328">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L329">              .appendln(&quot;public boolean valid() {&quot;)</span>
<span class="fc" id="L330">              .begin();</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L332">            writer.formatln(&quot;if (%s == null) {&quot;, UNION_FIELD)</span>
<span class="fc" id="L333">                  .appendln(&quot;    return false;&quot;)</span>
<span class="fc" id="L334">                  .appendln('}')</span>
<span class="fc" id="L335">                  .newline()</span>
<span class="fc" id="L336">                  .formatln(&quot;switch (%s) {&quot;, UNION_FIELD)</span>
<span class="fc" id="L337">                  .begin();</span>
<span class="fc" id="L338">            message.numericalOrderFields()</span>
<span class="fc" id="L339">                   .stream()</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">                   .filter(field -&gt; !field.alwaysPresent())</span>
<span class="fc" id="L341">                   .forEachOrdered(field -&gt; {</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">                       if (field.isVoid()) {</span>
                           // Void fields have no value.
<span class="fc" id="L344">                           writer.formatln(&quot;case %s: return true;&quot;, field.fieldEnum());</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">                       } else if (field.type() == PType.MESSAGE) {</span>
<span class="fc" id="L346">                           writer.formatln(&quot;case %s: return %s != null || %s_builder != null;&quot;,</span>
<span class="fc" id="L347">                                           field.fieldEnum(),</span>
<span class="fc" id="L348">                                           field.member(),</span>
<span class="fc" id="L349">                                           field.member());</span>
                       } else {
<span class="fc" id="L351">                           writer.formatln(&quot;case %s: return %s != null;&quot;, field.fieldEnum(), field.member());</span>
                       }
<span class="fc" id="L353">                   });</span>
<span class="fc" id="L354">            writer.appendln(&quot;default: return true;&quot;)</span>
<span class="fc" id="L355">                  .end()</span>
<span class="fc" id="L356">                  .appendln('}');</span>
        } else {
<span class="fc" id="L358">            writer.appendln(&quot;return &quot;)</span>
<span class="fc" id="L359">                  .begin(&quot;       &quot;);</span>
<span class="fc" id="L360">            boolean first = true;</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">            for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">                if (field.isRequired()) {</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">                    if (first) {</span>
<span class="fc" id="L364">                        first = false;</span>
                    } else {
<span class="fc" id="L366">                        writer.append(&quot; &amp;&amp;&quot;)</span>
<span class="fc" id="L367">                              .appendln(&quot;&quot;);</span>
                    }
<span class="fc" id="L369">                    writer.format(&quot;optionals.get(%d)&quot;, field.index());</span>
                }
<span class="fc" id="L371">            }</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">            if (first) {</span>
<span class="fc" id="L373">                writer.append(&quot;true&quot;);</span>
            }
<span class="fc" id="L375">            writer.end()  // alignment indent</span>
<span class="fc" id="L376">                  .append(';');</span>
        }
<span class="fc" id="L378">        writer.end()</span>
<span class="fc" id="L379">              .appendln('}')</span>
<span class="fc" id="L380">              .newline();</span>
<span class="fc" id="L381">    }</span>

    private void appendOverrideValidate(JMessage&lt;?&gt; message) {
<span class="fc" id="L384">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L385">              .appendln(&quot;public void validate() {&quot;)</span>
<span class="fc" id="L386">              .begin();</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L388">            writer.appendln(&quot;if (!valid()) {&quot;)</span>
<span class="fc" id="L389">                  .formatln(&quot;    throw new %s(\&quot;No union field set in %s\&quot;);&quot;,</span>
<span class="fc" id="L390">                            IllegalStateException.class.getName(),</span>
<span class="fc" id="L391">                            message.descriptor()</span>
<span class="fc" id="L392">                                   .getQualifiedName())</span>
<span class="fc" id="L393">                  .appendln(&quot;}&quot;);</span>
        } else {
<span class="fc" id="L395">            boolean hasRequired = message.declaredOrderFields()</span>
<span class="fc" id="L396">                                         .stream()</span>
<span class="fc" id="L397">                                         .anyMatch(JField::isRequired);</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">            if (hasRequired) {</span>
<span class="fc" id="L399">                writer.appendln(&quot;if (!valid()) {&quot;)</span>
<span class="fc" id="L400">                      .begin()</span>
<span class="fc" id="L401">                      .formatln(&quot;%s&lt;String&gt; missing = new %s&lt;&gt;();&quot;,</span>
<span class="fc" id="L402">                                ArrayList.class.getName(),</span>
<span class="fc" id="L403">                                ArrayList.class.getName())</span>
<span class="fc" id="L404">                      .newline();</span>

<span class="fc" id="L406">                message.declaredOrderFields()</span>
<span class="fc" id="L407">                       .stream()</span>
<span class="fc" id="L408">                       .filter(JField::isRequired)</span>
<span class="fc" id="L409">                       .forEachOrdered(field -&gt; writer.formatln(&quot;if (!optionals.get(%d)) {&quot;, field.index())</span>
<span class="fc" id="L410">                                                      .formatln(&quot;    missing.add(\&quot;%s\&quot;);&quot;, field.name())</span>
<span class="fc" id="L411">                                                      .appendln(&quot;}&quot;)</span>
<span class="fc" id="L412">                                                      .newline());</span>

<span class="fc" id="L414">                writer.formatln(&quot;throw new %s(&quot;, IllegalStateException.class.getName())</span>
<span class="fc" id="L415">                      .appendln(&quot;        \&quot;Missing required fields \&quot; +&quot;)</span>
<span class="fc" id="L416">                      .appendln(&quot;        String.join(\&quot;,\&quot;, missing) +&quot;)</span>
<span class="fc" id="L417">                      .formatln(&quot;        \&quot; in message %s\&quot;);&quot;,</span>
<span class="fc" id="L418">                                message.descriptor()</span>
<span class="fc" id="L419">                                       .getQualifiedName())</span>
<span class="fc" id="L420">                      .end()</span>
<span class="fc" id="L421">                      .appendln(&quot;}&quot;);</span>
            }
        }
<span class="fc" id="L424">        writer.end()</span>
<span class="fc" id="L425">              .appendln('}')</span>
<span class="fc" id="L426">              .newline();</span>

<span class="fc" id="L428">    }</span>

    private void appendOverrideDescriptor(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L431">        String typeClass = message.getDescriptorClass();</span>
<span class="fc" id="L432">        writer.appendln(JAnnotation.NON_NULL)</span>
<span class="fc" id="L433">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L434">              .formatln(&quot;public %s&lt;%s,_Field&gt; descriptor() {&quot;, typeClass, message.instanceType())</span>
<span class="fc" id="L435">              .begin()</span>
<span class="fc" id="L436">              .appendln(&quot;return kDescriptor;&quot;)</span>
<span class="fc" id="L437">              .end()</span>
<span class="fc" id="L438">              .appendln('}')</span>
<span class="fc" id="L439">              .newline();</span>

<span class="fc" id="L441">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>