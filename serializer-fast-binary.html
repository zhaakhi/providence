<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7 at 2016-06-11 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160611" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Providence &#x2013; Fast Binary Serializer Format</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/morimekta/providence">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Providence</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2016-06-11
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.1.2
                      </li>
                      
              
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Project Documentation</li>
                                                                                                                    
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                              <li class="nav-header">Introduction</li>
                              
      <li>
  
                          <a href="index.html" title="Providence">
          <span class="none"></span>
        Providence</a>
            </li>
                
      <li>
  
                          <a href="providence-tools.html" title="Providence Tools">
          <span class="none"></span>
        Providence Tools</a>
            </li>
                
      <li>
  
                          <a href="release.html" title="Release Process">
          <span class="none"></span>
        Release Process</a>
            </li>
                
      <li>
  
                          <a href="release-notes.html" title="Release Notes">
          <span class="none"></span>
        Release Notes</a>
            </li>
                
      <li>
  
                          <a href="downloads.html" title="Downloads">
          <span class="none"></span>
        Downloads</a>
            </li>
                              <li class="nav-header">Modules</li>
                              
      <li>
  
                          <a href="providence-core/index.html" title="Core">
          <span class="none"></span>
        Core</a>
            </li>
                
      <li>
  
                          <a href="providence-core-jackson/index.html" title="Core : Jackson">
          <span class="none"></span>
        Core : Jackson</a>
            </li>
                
      <li>
  
                          <a href="providence-core-client/index.html" title="Core : Client">
          <span class="none"></span>
        Core : Client</a>
            </li>
                
      <li>
  
                          <a href="providence-reflect/index.html" title="Tools : Reflect">
          <span class="none"></span>
        Tools : Reflect</a>
            </li>
                
      <li>
  
                          <a href="providence-generator/index.html" title="Tools : Generator">
          <span class="none"></span>
        Tools : Generator</a>
            </li>
                
      <li>
  
                          <a href="providence-maven-plugin/index.html" title="Tools : Maven Plugin">
          <span class="none"></span>
        Tools : Maven Plugin</a>
            </li>
                
      <li>
  
                          <a href="providence-thrift/index.html" title="Utils: Thrift Bridge">
          <span class="none"></span>
        Utils: Thrift Bridge</a>
            </li>
                
      <li>
  
                          <a href="providence-testing/index.html" title="Utils: Testing">
          <span class="none"></span>
        Utils: Testing</a>
            </li>
                              <li class="nav-header">Docs</li>
                              
      <li>
  
                          <a href="generated-java.html" title="Generated Java Code">
          <span class="none"></span>
        Generated Java Code</a>
            </li>
                
      <li>
  
                          <a href="serializer-binary.html" title="Serializer : Binary">
          <span class="none"></span>
        Serializer : Binary</a>
            </li>
                
      <li class="active">
  
            <a href="#"><span class="none"></span>Serializer : Fast Binary</a>
          </li>
                
      <li>
  
                          <a href="serializer-json.html" title="Serializer : JSON">
          <span class="none"></span>
        Serializer : JSON</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Fast Binary Serializer Format</h1>
<p>The fast binary serializer format is designed to be fast and compact. It is based upon the <a class="externalLink" href="https://developers.google.com/protocol-buffers/docs/encoding">Protocol Buffers</a> wire format, which does a couple of tricks to be both fast and compact. Note that this format is <b>not</b> compatible with protocol buffers. And in order to fix that, the type numbers have been shifted to avoid half-baked in-betweens.</p>
<p>My personal goal is to make this powerful enough to be the default encoding for providence and possibly also for thrift proper. The reason the latter is not very likely is a design-flaw in the thrift protocol libraries, which locks the wire format to have to know the exact data type it represent (i.e. i16 vs i64), even though it could be encoded the exact same way (the thrift JSON protocol is a monstrosity for this reason alone).</p>
<div class="section">
<h2><a name="Number_Encoding"></a>Number Encoding</h2>
<p>Numbers are mostly encoded using the base 128 varint as described in the protocol buffers encoding doc. The exception is <tt>double</tt> values which are encoded using a fixed 64-bit buffer, with 1:11:52 (sign:exp:dec), and then little-endian encoded unto the stream.</p>
<div class="section">
<h3><a name="Base_128_Varints"></a>Base 128 Varints</h3>
<p>Most integer numbers are encoded with <a class="externalLink" href="https://en.wikipedia.org/wiki/LEB128">base-128</a> varints to ensure it uses a small wire footprint. Unsigned integers are encoded directly with base-128, and signed are zigzag-encoded before base-128 encoding.</p></div>
<div class="section">
<h3><a name="Zigzag_Encoded_Integers"></a>Zigzag Encoded Integers</h3>
<p>All the scalar integer values are encoded with zigzag encoding as negative numbers would all be encoded with 5 bytes in the simple base-128 format (for i32, 10 bytes for i64). This is compact and efficient in most cases (except when using 64-bit random numbers, though 10 bytes is not too much more than 8, so the loss is still small.</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="right">Original Value </th>
      
<th align="right">Encoded Value </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="right">0 </td>
      
<td align="right">0 </td>
    </tr>
    
<tr class="a">
      
<td align="right">-1 </td>
      
<td align="right">1 </td>
    </tr>
    
<tr class="b">
      
<td align="right">1 </td>
      
<td align="right">2 </td>
    </tr>
    
<tr class="a">
      
<td align="right">-2 </td>
      
<td align="right">3 </td>
    </tr>
    
<tr class="b">
      
<td align="right">2 </td>
      
<td align="right">4 </td>
    </tr>
    
<tr class="a">
      
<td align="right">&#x2026; </td>
      
<td align="right">&#x2026; </td>
    </tr>
    
<tr class="b">
      
<td align="right">-2147483646 </td>
      
<td align="right">4294967291 </td>
    </tr>
    
<tr class="a">
      
<td align="right">2147483646 </td>
      
<td align="right">4294967292 </td>
    </tr>
    
<tr class="b">
      
<td align="right">-2147483647 </td>
      
<td align="right">4294967293 </td>
    </tr>
    
<tr class="a">
      
<td align="right">2147483647 </td>
      
<td align="right">4294967294 </td>
    </tr>
    
<tr class="b">
      
<td align="right">-2147483648 </td>
      
<td align="right">4294967295 </td>
    </tr>
  </tbody>
</table>
<p>The encoding is done using the formula <tt>(number &lt;&lt; 1) ^ (number &gt;&gt; 31)</tt> for i32 and <tt>(number &lt;&lt; 1) ^ (number &gt;&gt; 63)</tt> for i64. Decoding is done using <tt>(value &amp; 1) != 0 ? ~(value &gt;&gt;&gt; 1) : value &gt;&gt;&gt; 1</tt>. Note that <tt>&gt;&gt;</tt> is an arithmetic shift (keeping the sign bit), while <tt>&gt;&gt;&gt;</tt> is a logical shift (not keeping the sign bit).</p></div></div>
<div class="section">
<h2><a name="Service_Calls"></a>Service Calls</h2>
<p>Service calls are encoded as a fixed 5-tuple of:</p>

<ol style="list-style-type: decimal">
  
<li>base-128 varint of (method name length &lt;&lt; 3 | call type). The call type  will determine the content of the message field.
  
<ul>
    
<li><tt>call</tt>, <b>1</b>: Method request wrapper.</li>
    
<li><tt>reply</tt>, <b>2</b>: Method response wrapper.</li>
    
<li><tt>exception</tt>, <b>3</b>: Application exception.</li>
    
<li><tt>oneway</tt>, <b>4</b>: Method request wrapper, but no reply expected.</li>
  </ul></li>
  
<li>method name data (utf-8 encoded, of length from <tt>1.</tt>).</li>
  
<li>base-128 varint sequence number.</li>
  
<li>The method wrapper message or exception.</li>
</ol>
<p>The application exception is defined as:</p>

<div class="source">
<div class="source"><pre class="prettyprint">enum ApplicationExceptionType {
  UNKNOWN                 =  0;
  UNKNOWN_METHOD          =  1;
  INVALID_MESSAGE_TYPE    =  2;
  WRONG_METHOD_NAME       =  3;
  BAD_SEQUENCE_ID         =  4;
  MISSING_RESULT          =  5;
  INTERNAL_ERROR          =  6;
  PROTOCOL_ERROR          =  7;
  INVALID_TRANSFORM       =  8;
  INVALID_PROTOCOL        =  9;
  UNSUPPORTED_CLIENT_TYPE = 10;
}

exception ApplicationException {
    1: string message
    2: ApplicationExceptionType id
}
</pre></div></div></div>
<div class="section">
<h2><a name="Message_Encoding"></a>Message Encoding</h2>
<p>The message is encoded as a stream of fields, ending in a field with ID 0 (type ignored), combined with a 3-bit field type. Note that the field type only describes which <i>wire format</i> the value is encoded as.</p>

<ul>
  
<li><b>0x00 = STOP</b>: Stop reading fields.</li>
  
<li><b>0x01 = NONE</b>: No value; Boolean false ( <i>bool</i>, <i>void</i> ).</li>
  
<li><b>0x02 = TRUE</b>: No value; Boolean true ( <i>bool</i> ).</li>
  
<li><b>0x03 = VARINT</b>: Zigzag encoded base-128 number ( <i>byte</i>, <i>i8</i>, <i>i16</i>, <i>i32</i>, <i>i64</i> ).</li>
  
<li><b>0x04 = FIXED_64</b>: 8 bytes, little endian encoded ( <i>double</i> ).</li>
  
<li><b>0x05 = BINARY</b>: base-128 encoded length + binary data ( <i>string</i>, <i>binary</i> ).</li>
  
<li><b>0x06 = MESSAGE</b>: enclosed message, terminated with field-ID 0 ( <i>struct</i>, <i>union</i>, <i>exception</i> ).</li>
  
<li><b>0x07 = COLLECTION</b>: (base-128 encoded length N) + (tags) N * (item) ( <i>list</i>, <i>set</i>, <i>map</i> ).</li>
</ul>
<p>The two values are combined as: <tt>tag :== (field-id &lt;&lt; 3) | type</tt>, written as a base-128 varint (not zigzag encoded), followed by the value as described.</p>
<div class="section">
<h3><a name="Container_Encoding"></a>Container Encoding</h3>
<p>Containers are encoded as a repeated set of fields, one for each value. In the case of maps, there are 2 values per entry, one for the key and one for the value, which also makes the length / size double that of the actual number of entries.</p>
<p>Lists and sets are encoded the same way.</p>
<p><tt>[$field-id &lt;&lt; 3 | 0x06] [base-128 $length] [$item-type] ($length * [$item-value])</tt></p>
<p>Maps are a bit more complicated as it contains keys and values os possibly different types, so they are encoded like:</p>
<p><tt>[$field-id &lt;&lt; 3 | 0x06] [base-128 2 * $length] [$key-type &lt;&lt; 3 | $item-type] ($length * ([$key-value] [$item-value]))</tt></p>
<p>This way it will appear as a list of <tt>2 * N</tt> elements with alternating key and value types. Since the type is a 3-bit value, both types fit in a 7-bit int and is double encoded the same way the field + type is encoded. In order to fit boolean values into the collection as values, and not a type-determined value, it is stored as a base-128 varint (type 3) with value 0 or 1.</p></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                          <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-3087264-4', 'auto');
                ga('send', 'pageview');
            </script>
                </div>

        
                </div>
    </footer>
        </body>
</html>
