<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeneratorBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Utils : Testing</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.testing.generator</a> &gt; <span class="el_source">GeneratorBase.java</span></div><h1>GeneratorBase.java</h1><pre class="source lang-java linenums">package net.morimekta.providence.testing.generator;

import net.morimekta.providence.PEnumValue;
import net.morimekta.providence.PMessage;
import net.morimekta.providence.PType;
import net.morimekta.providence.descriptor.PDescriptor;
import net.morimekta.providence.descriptor.PEnumDescriptor;
import net.morimekta.providence.descriptor.PField;
import net.morimekta.providence.descriptor.PList;
import net.morimekta.providence.descriptor.PMap;
import net.morimekta.providence.descriptor.PMessageDescriptor;
import net.morimekta.providence.descriptor.PPrimitive;
import net.morimekta.providence.descriptor.PSet;
import net.morimekta.providence.testing.generator.defaults.BinaryGenerator;
import net.morimekta.providence.testing.generator.defaults.BoolGenerator;
import net.morimekta.providence.testing.generator.defaults.ByteGenerator;
import net.morimekta.providence.testing.generator.defaults.DoubleGenerator;
import net.morimekta.providence.testing.generator.defaults.EnumGenerator;
import net.morimekta.providence.testing.generator.defaults.IntGenerator;
import net.morimekta.providence.testing.generator.defaults.ListGenerator;
import net.morimekta.providence.testing.generator.defaults.LongGenerator;
import net.morimekta.providence.testing.generator.defaults.MapGenerator;
import net.morimekta.providence.testing.generator.defaults.SetGenerator;
import net.morimekta.providence.testing.generator.defaults.ShortGenerator;
import net.morimekta.providence.testing.generator.defaults.StringGenerator;

import io.codearte.jfairy.Fairy;

import javax.annotation.Nonnull;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;
import java.util.Random;
import java.util.function.Consumer;

/**
 * Options and context container for managing a set of message generators and
 * associated value generators.
 *
 * Note that all classes who extend the GeneratorBase must have a
 * public copy constructor.
 */
public abstract class GeneratorBase&lt;
        Base extends GeneratorBase&lt;Base, Context&gt;,
        Context extends GeneratorContext&lt;Context&gt;&gt; {
<span class="fc" id="L49">    private static final Fairy DEFAULT_FAIRY = Fairy.create(Locale.ENGLISH);</span>

    private final Map&lt;PMessageDescriptor, MessageGenerator&gt; defaultMessageGenerators;
    private final Map&lt;PEnumDescriptor, Generator&gt;           defaultEnumGenerators;
    private final EnumMap&lt;PType, Generator&lt;Context, ?&gt;&gt; primitiveCache;

    private Fairy  fairy;
    private Random random;
    private double defaultFillRate;
    private int    defaultMaxCollectionSize;

    /**
     * Default generator context.
     */
    public GeneratorBase() {
<span class="fc" id="L64">        this(DEFAULT_FAIRY, new Random());</span>
<span class="fc" id="L65">    }</span>

    /**
     *
     * @param fairy Fairy instance.
     * @param random Random instance.
     */
    public GeneratorBase(Fairy fairy,
                         Random random) {
<span class="fc" id="L74">        this(fairy, random, 1.0, 10);</span>
<span class="fc" id="L75">    }</span>

    /**
     *
     * @param fairy Fairy instance.
     * @param random Random instance.
     * @param defaultFillRate The default fill rate.
     * @param defaultMaxCollectionSize The max collection size.
     */
    public GeneratorBase(Fairy fairy,
                         Random random,
                         double defaultFillRate,
                         int defaultMaxCollectionSize) {
<span class="fc" id="L88">        this(new HashMap&lt;&gt;(), new HashMap&lt;&gt;(), defaultFillRate, defaultMaxCollectionSize, fairy, random);</span>
<span class="fc" id="L89">    }</span>

    private GeneratorBase(Map&lt;PMessageDescriptor, MessageGenerator&gt; defaultMessageGenerators,
                          Map&lt;PEnumDescriptor, Generator&gt; defaultEnumGenerators,
                          double defaultFillRate,
                          int defaultMaxCollectionSize,
                          Fairy fairy,
<span class="fc" id="L96">                          Random random) {</span>
<span class="fc" id="L97">        this.fairy = fairy;</span>
<span class="fc" id="L98">        this.random = random;</span>
<span class="fc" id="L99">        this.primitiveCache = new EnumMap&lt;&gt;(PType.class);</span>

<span class="fc" id="L101">        this.defaultFillRate = defaultFillRate;</span>
<span class="fc" id="L102">        this.defaultMaxCollectionSize = defaultMaxCollectionSize;</span>
<span class="fc" id="L103">        this.defaultMessageGenerators = defaultMessageGenerators;</span>
<span class="fc" id="L104">        this.defaultEnumGenerators = defaultEnumGenerators;</span>
<span class="fc" id="L105">    }</span>

    /**
     * Create the context instance used when generating messages.
     *
     * @return The new context class.
     */
    public abstract Context createContext();

    /**
     * Copy constructor.
     *
     * @param copyOf Instance to make copy of.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public GeneratorBase(GeneratorBase&lt;Base, Context&gt; copyOf) {
<span class="fc" id="L121">        this(new HashMap&lt;&gt;(),</span>
             new HashMap&lt;&gt;(),
             copyOf.defaultFillRate,
             copyOf.defaultMaxCollectionSize,
             copyOf.fairy,
             copyOf.random);

        for (Map.Entry&lt;PMessageDescriptor, MessageGenerator&gt; entry :
<span class="fc bfc" id="L129" title="All 2 branches covered.">                copyOf.defaultMessageGenerators.entrySet()) {</span>
<span class="fc" id="L130">            defaultMessageGenerators.put(entry.getKey(), entry.getValue().deepCopy());</span>
<span class="fc" id="L131">        }</span>
        for (Map.Entry&lt;PEnumDescriptor, Generator&gt; entry :
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">                copyOf.defaultEnumGenerators.entrySet()) {</span>
<span class="nc" id="L134">            defaultEnumGenerators.put(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L135">        }</span>
<span class="fc" id="L136">    }</span>

    @Nonnull
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T&gt;
    Generator&lt;Context, T&gt; generatorFor(@Nonnull PDescriptor type) {
<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (type instanceof PMessageDescriptor) {</span>
<span class="fc" id="L143">            return messageGeneratorFor((PMessageDescriptor) type);</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">        } else if (type instanceof PEnumDescriptor) {</span>
<span class="fc" id="L145">            return enumGeneratorFor((PEnumDescriptor) type);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">        } else if (type instanceof PPrimitive) {</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">            if (!primitiveCache.containsKey(type.getType())) {</span>
<span class="fc" id="L148">                primitiveCache.put(type.getType(), makeGeneratorInternal(type));</span>
            }
<span class="fc" id="L150">            return (Generator&lt;Context, T&gt;) primitiveCache.get(type.getType());</span>
        } else {
            // Containers are not cached.
<span class="fc" id="L153">            return makeGeneratorInternal(type);</span>
        }
    }

    @Nonnull
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;E extends PEnumValue&lt;E&gt;&gt;
    Generator&lt;Context, E&gt; enumGeneratorFor(PEnumDescriptor&lt;E&gt; descriptor) {
<span class="fc" id="L161">        EnumGenerator&lt;Context,E&gt; generator = (EnumGenerator) defaultEnumGenerators.get(descriptor);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (generator == null) {</span>
<span class="fc" id="L163">            generator = new EnumGenerator&lt;&gt;(descriptor);</span>
<span class="fc" id="L164">            defaultEnumGenerators.put(descriptor, generator);</span>
        }
<span class="fc" id="L166">        return generator;</span>
    }

    /**
     * Get the default generator for type, or create one if it does not exists.
     * This generator can be modified and is kept around.
     *
     * @param descriptor The message descriptor.
     * @param &lt;M&gt; The message type.
     * @param &lt;F&gt; The message field type.
     * @return The message generator.
     */
    @Nonnull
    public &lt;M extends PMessage&lt;M, F&gt;, F extends PField&gt;
    MessageGenerator&lt;Context, M, F&gt; messageGeneratorFor(PMessageDescriptor&lt;M, F&gt; descriptor) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L182">        MessageGenerator&lt;Context, M, F&gt; generator = defaultMessageGenerators.get(descriptor);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">        if (generator == null) {</span>
<span class="fc" id="L184">            generator = new MessageGenerator&lt;&gt;(descriptor);</span>
<span class="fc" id="L185">            defaultMessageGenerators.put(descriptor, generator);</span>
        }
<span class="fc" id="L187">        return generator;</span>
    }

    /**
     * Set the default enum generator for the enum type.
     *
     * @param descriptor The enum descriptor.
     * @param generator The enum value generator.
     * @param &lt;E&gt; The enum type.
     * @return The generator context.
     */
    @Nonnull
    public &lt;E extends PEnumValue&lt;E&gt;&gt;
    Base withEnumGenerator(PEnumDescriptor&lt;E&gt; descriptor,
                           Generator&lt;Context, E&gt; generator) {
<span class="nc" id="L202">        defaultEnumGenerators.put(descriptor, generator);</span>
<span class="nc" id="L203">        return self();</span>
    }

    /**
     * Set the default message generator for the message type.
     *
     * @param descriptor The message descriptor.
     * @param generator The message value generator.
     * @param &lt;M&gt; The message type.
     * @param &lt;F&gt; The message field type.
     * @return The generator context.
     */
    @Nonnull
    public &lt;M extends PMessage&lt;M, F&gt;, F extends PField&gt;
    Base withMessageGenerator(PMessageDescriptor&lt;M, F&gt; descriptor,
                              MessageGenerator&lt;Context, M, F&gt; generator) {
<span class="nc" id="L219">        defaultMessageGenerators.put(descriptor, generator);</span>
<span class="nc" id="L220">        return self();</span>
    }

    /**
     * Get the default message generator for the given message type, and
     * apply the closure context on that.
     *
     * @param descriptor The message descriptor.
     * @param closure The closure working on the generator.
     * @param &lt;M&gt; The message type.
     * @param &lt;F&gt; the message field type.
     * @return The generator context.
     */
    @Nonnull
    public &lt;M extends PMessage&lt;M, F&gt;, F extends PField&gt;
    Base withMessageGenerator(PMessageDescriptor&lt;M, F&gt; descriptor,
                              Consumer&lt;MessageGenerator&lt;Context, M, F&gt;&gt; closure) {
<span class="fc" id="L237">        closure.accept(messageGeneratorFor(descriptor));</span>
<span class="fc" id="L238">        return self();</span>
    }

    // -------------------------------------------
    // ----                                   ----
    // ----       GETTERS AND SETTERS         ----
    // ----                                   ----
    // -------------------------------------------

    /**
     * @return The current fairy instance.
     */
    @Nonnull
    public Fairy getFairy() {
<span class="fc" id="L252">        return fairy;</span>
    }

    /**
     * @param fairy The new fairy instance.
     * @return The generator context.
     */
    @Nonnull
    public Base setFairy(Fairy fairy) {
<span class="fc" id="L261">        this.fairy = fairy;</span>
<span class="fc" id="L262">        return self();</span>
    }

    /**
     * @return The current random instance.
     */
    @Nonnull
    public Random getRandom() {
<span class="fc" id="L270">        return random;</span>
    }

    /**
     * @param random The new random instance.
     * @return The generator context.
     */
    @Nonnull
    public Base setRandom(Random random) {
<span class="fc" id="L279">        this.random = random;</span>
<span class="fc" id="L280">        return self();</span>
    }

    /**
     * @return The default max collection size.
     */
    public int getDefaultMaxCollectionSize() {
<span class="fc" id="L287">        return defaultMaxCollectionSize;</span>
    }

    /**
     * @param defaultMaxCollectionSize The new default max collection size.
     * @return The generator context.
     */
    @Nonnull
    public Base setDefaultMaxCollectionSize(int defaultMaxCollectionSize) {
<span class="fc" id="L296">        this.defaultMaxCollectionSize = defaultMaxCollectionSize;</span>
<span class="fc" id="L297">        return self();</span>
    }

    /**
     * @return The current default fill rate.
     */
    public double getDefaultFillRate() {
<span class="fc" id="L304">        return defaultFillRate;</span>
    }

    /**
     * @param defaultFillRate The new default fill rate.
     * @return The generator context.
     */
    @Nonnull
    public Base setDefaultFillRate(double defaultFillRate) {
<span class="fc" id="L313">        this.defaultFillRate = defaultFillRate;</span>
<span class="fc" id="L314">        return self();</span>
    }

    // -------------------------------------------
    // ----                                   ----
    // ----         INTERNAL METHODS          ----
    // ----                                   ----
    // -------------------------------------------

    @SuppressWarnings(&quot;unchecked&quot;)
    protected Base deepCopy() {
        try {
<span class="fc" id="L326">            Constructor constructor = getClass().getConstructor(getClass());</span>
<span class="fc" id="L327">            return (Base) constructor.newInstance(this);</span>
<span class="nc" id="L328">        } catch (NoSuchMethodException | InvocationTargetException | InstantiationException | IllegalAccessException e) {</span>
<span class="nc" id="L329">            throw new AssertionError(e.getMessage(), e);</span>
        }
    }

    @Nonnull
    @SuppressWarnings(&quot;unchecked&quot;)
    private Base self() {
<span class="fc" id="L336">        return (Base) this;</span>
    }

    @Nonnull
    @SuppressWarnings(&quot;unchecked&quot;)
    private &lt;T&gt;
    Generator&lt;Context, T&gt; makeGeneratorInternal(@Nonnull PDescriptor type) {
<span class="pc bpc" id="L343" title="4 of 15 branches missed.">        switch (type.getType()) {</span>
            case VOID:
<span class="nc" id="L345">                return ctx -&gt; (T) Boolean.TRUE;</span>
            case BOOL:
<span class="fc" id="L347">                return new BoolGenerator();</span>
            case BYTE:
<span class="fc" id="L349">                return new ByteGenerator();</span>
            case I16:
<span class="fc" id="L351">                return new ShortGenerator();</span>
            case I32:
<span class="fc" id="L353">                return new IntGenerator();</span>
            case I64:
<span class="fc" id="L355">                return new LongGenerator();</span>
            case DOUBLE:
<span class="fc" id="L357">                return new DoubleGenerator();</span>
            case STRING:
<span class="fc" id="L359">                return new StringGenerator();</span>
            case BINARY:
<span class="fc" id="L361">                return new BinaryGenerator();</span>
            case LIST:
<span class="fc" id="L363">                return new ListGenerator((PList&lt;Object&gt;) type);</span>
            case SET:
<span class="fc" id="L365">                return new SetGenerator((PSet&lt;Object&gt;) type);</span>
            case MAP:
<span class="fc" id="L367">                return new MapGenerator((PMap&lt;Object,Object&gt;) type);</span>
            case ENUM:
<span class="nc" id="L369">                return enumGeneratorFor((PEnumDescriptor) type);</span>
            case MESSAGE:
<span class="nc" id="L371">                return messageGeneratorFor((PMessageDescriptor) type);</span>
        }
<span class="nc" id="L373">        throw new IllegalArgumentException(&quot;Unhandled default type: &quot; + type.getType());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>